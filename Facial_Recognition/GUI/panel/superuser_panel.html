<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SuperUser Panel</title>
  <link rel="stylesheet" href="css/superuser_panel.css">
</head>
<body>
  <div class="container">
    <header>
      <h1 id="greeting">Chào mừng, SuperUser</h1>
    </header>

    <!-- Tab navigation -->
    <div class="tabview">
      <div class="tabs">
        <button class="tablink active" data-tab="students">Quản lý Học sinh</button>
        <button class="tablink" data-tab="users">Quản lý Tài khoản</button>
      </div>

      <!-- Students -->
      <div id="students" class="tabcontent active">
        <div class="search-bar">
          <label for="search-input"></label>
          <input type="text" id="search-input" placeholder="Tìm kiếm học sinh...">
          <button id="search-button">Tìm kiếm</button>
        </div>
        <div class="controls">
          <button id="add-student">Thêm học sinh</button>
          <button id="edit-student">Chỉnh sửa học sinh</button>
          <button id="delete-student">Xoá học sinh</button>
          <button id="batch-add">Thêm hàng loạt</button>
          <button id="set-cutoff">Đặt thời hạn điểm danh</button>
          <button id="export-students">Xuất danh sách</button>
        </div>
        <div class="table-container">
          <table id="students-table">
            <thead>
              <tr>
                <th>STT</th>
                <th>UID</th>
                <th>Họ Và Tên</th>
                <th>Lớp</th>
                <th>Giới Tính</th>
                <th>Ngày Sinh</th>
                <th>Trạng Thái Điểm Danh</th>
                <th>Thời Gian Điểm Danh</th>
              </tr>
            </thead>
            <tbody>
              <!-- Render by JavaScript -->
            </tbody>
          </table>
          <div id="no-data" class="no-data">Không có dữ liệu</div>
        </div>
      </div>

      <!-- Users -->
      <div id="users" class="tabcontent">
        <div class="controls">
          <button id="add-user-btn">Thêm người dùng</button>
          <button id="edit-user-btn">Chỉnh sửa người dùng</button>
          <button id="delete-user-btn">Xoá người dùng</button>
        </div>
        <div class="table-container">
          <table id="users-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Tên tài khoản</th>
                <th>Quyền</th>
              </tr>
            </thead>
            <tbody>
              <!-- Render by JavaScript -->
            </tbody>
          </table>
          <div id="no-users" class="no-data">Không có dữ liệu</div>
        </div>
        <!-- Hiển thị thông tin người dùng khi được chọn -->
        <div id="user-detail" class="detail-info" style="display: none;">
          <h3>Thông tin người dùng</h3>
          <p id="detail-username"></p>
          <p id="detail-role"></p>
        </div>
      </div>
    </div>

    <div class="bottom-controls">
      <button id="logout">Đăng xuất</button>
      <button id="quit">Thoát</button>
    </div>
  </div>

  <!-- Các Popup -->
  <!-- Popup Thêm Học Sinh -->
  <div id="add-student-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Thêm Học sinh</div>
      <label for="add-image">Chọn ảnh học sinh:</label>
      <input type="file" id="add-image" accept="image/*">
      <label for="add-HoVaTen">Họ Và Tên:</label>
      <input type="text" id="add-HoVaTen" placeholder="Nhập họ và tên">
      <label for="add-Lop">Lớp:</label>
      <input type="text" id="add-Lop" placeholder="Nhập lớp">
      <label for="add-Gender">Giới Tính:</label>
      <input type="text" id="add-Gender" placeholder="Nhập giới tính">
      <label for="add-NgaySinh">Ngày Sinh:</label>
      <input type="date" id="add-NgaySinh">
      <div class="modal-buttons">
        <button id="save-add-student" class="btn-save">Lưu</button>
        <button id="cancel-add-student" class="btn-cancel">Huỷ</button>
      </div>
    </div>
  </div>

  <!-- Popup Chỉnh Sửa Học Sinh -->
  <div id="edit-student-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Chỉnh Sửa Học sinh</div>
      <label for="edit-image">Chọn ảnh học sinh (nếu muốn đổi):</label>
      <input type="file" id="edit-image" accept="image/*">
      <label for="edit-HoVaTen">Họ Và Tên:</label>
      <input type="text" id="edit-HoVaTen" placeholder="Nhập họ và tên">
      <label for="edit-Lop">Lớp:</label>
      <input type="text" id="edit-Lop" placeholder="Nhập lớp">
      <label for="edit-Gender">Giới Tính:</label>
      <input type="text" id="edit-Gender" placeholder="Nhập giới tính">
      <label for="edit-NgaySinh">Ngày Sinh:</label>
      <input type="date" id="edit-NgaySinh">
      <input type="hidden" id="edit-ImagePath">
      <div class="modal-buttons">
        <button id="save-edit-student" class="btn-save">Lưu</button>
        <button id="cancel-edit-student" class="btn-cancel">Huỷ</button>
      </div>
    </div>
  </div>

  <!-- Popup Thêm Hàng Loạt Học Sinh -->
  <div id="batch-add-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Thêm Hàng Loạt Học Sinh</div>
      <label for="batch-folder-input">Chọn thư mục chứa ảnh học sinh:</label>
      <div class="folder-select">
        <input type="file" id="batch-folder-input" webkitdirectory directory style="display: none;">
        <button id="select-folder">Chọn thư mục</button>
      </div>
      <div id="batch-student-count" class="info">
        Số lượng học sinh: <span>0</span>
      </div>
      <div class="reminder" style="margin-top: 10px;">
        <span style="font-size: 24px;">⚠️</span>
        <span style="margin-left: 5px;">Lưu ý: Bạn phải chỉnh sửa thủ công qua nút <strong>Chỉnh sửa học sinh</strong>.</span>
      </div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button id="save-batch-add" class="btn-save">Lưu</button>
        <button id="cancel-batch-add" class="btn-cancel">Huỷ</button>
      </div>
    </div>
  </div>

  <!-- Popup Đặt Thời Hạn Điểm Danh -->
  <div id="set-cutoff-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Đặt Thời Hạn Điểm Danh</div>
      <div class="form-group" style="margin-bottom: 15px;">
        <label for="cutoff-gmt">Chọn múi giờ GMT:</label>
        <input type="text" id="cutoff-gmt" placeholder="Ví dụ: GMT+7">
      </div>
      <div class="form-group" style="margin-bottom: 15px;">
        <label for="cutoff-time">Thời gian điểm danh (HH:MM):</label>
        <input type="time" id="cutoff-time" placeholder="HH:MM">
      </div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button id="save-cutoff" class="btn-save">Lưu</button>
        <button id="cancel-cutoff" class="btn-cancel">Huỷ</button>
      </div>
    </div>
  </div>

  <!-- Popup Thêm Người Dùng -->
  <div id="add-user-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Thêm Người Dùng</div>
      <label for="add-username">Tên Người Dùng:</label>
      <input type="text" id="add-username" placeholder="Nhập tên người dùng">
      <label for="add-password">Mật Khẩu:</label>
      <input type="password" id="add-password" placeholder="Nhập mật khẩu">
      <label for="add-role">Quyền Hạn:</label>
      <select id="add-role">
        <option value="user">User</option>
        <option value="moderator">Moderator</option>
        <option value="admin">Admin</option>
        <option value="superuser">Superuser</option>
      </select>
      <div class="modal-buttons">
        <button id="save-add-user" class="btn-save">Lưu</button>
        <button id="cancel-add-user" class="btn-cancel">Huỷ</button>
      </div>
    </div>
  </div>

  <!-- Popup Chỉnh Sửa Người Dùng -->
  <div id="edit-user-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Chỉnh Sửa Người Dùng</div>
      <label for="edit-username">Tên Người Dùng:</label>
      <input type="text" id="edit-username" placeholder="Nhập tên người dùng">
      <label for="edit-password">Mật Khẩu:</label>
      <input type="password" id="edit-password" placeholder="Nhập mật khẩu">
      <label for="edit-role">Quyền Hạn:</label>
      <select id="edit-role">
        <option value="user">User</option>
        <option value="moderator">Moderator</option>
        <option value="admin">Admin</option>
        <option value="superuser">Superuser</option>
      </select>
      <div class="modal-buttons">
        <button id="save-edit-user" class="btn-save">Lưu</button>
        <button id="cancel-edit-user" class="btn-cancel">Huỷ</button>
      </div>
    </div>
  </div>

  <!-- Popup Xoá Người Dùng -->
  <div id="delete-user-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Xoá Người Dùng</div>
      <p>Bạn có chắc muốn xoá người dùng <span id="delete-username-display"></span>?</p>
      <div class="modal-buttons">
        <button id="confirm-delete-user" class="btn-save">Xoá</button>
        <button id="cancel-delete-user" class="btn-cancel">Huỷ</button>
      </div>
    </div>
  </div>

  <!-- Notification Popup Container -->
  <div id="notification-container"></div>

  <!-- SCRIPTS -->
  <script>
    // Hàm hiển thị thông báo có animation
    function showNotification(type, message) {
      const container = document.getElementById("notification-container");
      const notif = document.createElement("div");
      notif.className = "notification show";
      const icon = document.createElement("span");
      icon.style.fontSize = "24px";
      icon.style.marginRight = "10px";
      icon.textContent = type === "success" ? "✔️" : "❌";
      const msg = document.createElement("span");
      msg.className = "notification-message";
      msg.textContent = message;
      notif.appendChild(icon);
      notif.appendChild(msg);
      container.appendChild(notif);
      setTimeout(() => {
        notif.classList.remove("show");
        container.removeChild(notif);
      }, 3000);
    }

    // Hàm mở/đóng modal
    function openModal(id) {
      document.getElementById(id).style.display = "block";
    }
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }

    // Hàm autofill từ tên file (có thể chỉnh sửa theo nhu cầu)
    function autofillFromFilename(filename, nameFieldId, classFieldId) {
      const nameField = document.getElementById(nameFieldId);
      const classField = document.getElementById(classFieldId);
      // Ví dụ: giả sử tên file có dạng "NguyenVanA_Class10.jpg"
      const parts = filename.split('_');
      if (parts.length >= 2) {
        nameField.value = parts[0];
        classField.value = parts[1].split('.')[0];
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // Chuyển tab
      const tablinks = document.querySelectorAll('.tablink');
      const tabcontents = document.querySelectorAll('.tabcontent');
      tablinks.forEach(btn => {
        btn.addEventListener('click', () => {
          tablinks.forEach(b => b.classList.remove('active'));
          tabcontents.forEach(tc => tc.classList.remove('active'));
          btn.classList.add('active');
          const tabId = btn.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
        });
      });

      // Các hàm render dữ liệu
      let selectedStudent = null;
      let selectedUser = null;

      function renderStudents(students) {
        const tbody = document.querySelector("#students-table tbody");
        tbody.innerHTML = "";
        selectedStudent = null;
        if (!students || students.length === 0) {
          document.getElementById("no-data").style.display = "block";
        } else {
          document.getElementById("no-data").style.display = "none";
          students.forEach((student, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${index + 1}</td>
              <td>${student.UID}</td>
              <td>${student.HoVaTen}</td>
              <td>${student.Lop}</td>
              <td>${student.Gender}</td>
              <td>${student.NgaySinh}</td>
              <td>${student.DiemDanhStatus}</td>
              <td>${student.ThoiGianDiemDanh || ""}</td>`;
            tr.addEventListener("click", () => {
              document.querySelectorAll("#students-table tbody tr").forEach(row => row.classList.remove("selected-row"));
              tr.classList.add("selected-row");
              selectedStudent = student;
            });
            tbody.appendChild(tr);
          });
        }
      }

      function renderUsers(users) {
        const tbody = document.querySelector("#users-table tbody");
        tbody.innerHTML = "";
        selectedUser = null;
        // Ẩn thông tin chi tiết khi reload danh sách
        document.getElementById("user-detail").style.display = "none";
        if (!users || users.length === 0) {
          document.getElementById("no-users").style.display = "block";
        } else {
          document.getElementById("no-users").style.display = "none";
          users.forEach((user, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${index + 1}</td>
              <td>${user.username}</td>
              <td>${user.role}</td>`;
            tr.addEventListener("click", () => {
              document.querySelectorAll("#users-table tbody tr").forEach(row => row.classList.remove("selected-row"));
              tr.classList.add("selected-row");
              selectedUser = user;
              // Hiển thị thông tin chi tiết của người dùng được chọn
              document.getElementById("detail-username").textContent = "Tên: " + user.username;
              document.getElementById("detail-role").textContent = "Quyền: " + user.role;
              document.getElementById("user-detail").style.display = "block";
            });
            tbody.appendChild(tr);
          });
        }
      }

      // API function wrapper
      const PanelFunctions = {
        fetchStudents: function(callback) {
          fetch('/api/students')
            .then(response => response.json())
            .then(data => {
              if (data.success) callback(data.students);
              else showNotification("error", "Lỗi khi lấy danh sách học sinh: " + data.message);
            })
            .catch(err => showNotification("error", "Lỗi kết nối: " + err));
        },
        addStudent: function(studentData, callback) {
          fetch('/api/add_student', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(studentData)
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification("success", "Thêm học sinh thành công!");
                callback();
              } else showNotification("error", "Lỗi khi thêm học sinh: " + data.message);
            })
            .catch(err => showNotification("error", "Lỗi kết nối: " + err));
        },
        editStudent: function(studentId, updateData, callback) {
          updateData.id = studentId;
          fetch('/api/edit_student', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification("success", "Chỉnh sửa học sinh thành công!");
                callback();
              } else showNotification("error", "Lỗi khi chỉnh sửa học sinh: " + data.message);
            })
            .catch(err => showNotification("error", "Lỗi kết nối: " + err));
        },
        deleteStudent: function(UID, callback) {
          fetch('/api/delete_student', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ UID: UID })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification("success", "Xoá học sinh thành công!");
                callback();
              } else showNotification("error", "Lỗi khi xoá học sinh: " + data.message);
            })
            .catch(err => showNotification("error", "Lỗi kết nối: " + err));
        },
        batchAddStudents: function(folderPath, callback) {
          fetch('/api/batch_add_students', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify([folderPath])
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification("success", "Đã thêm " + data.added_count + " học sinh.");
                callback();
              } else showNotification("error", "Lỗi khi thêm hàng loạt học sinh: " + data.message);
            })
            .catch(err => showNotification("error", "Lỗi kết nối: " + err));
        },
        setCutoff: function(gmt, cutoff, callback) {
          fetch('/api/set_cutoff', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gmt: gmt, cutoff: cutoff })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification("success", "Đặt hạn chót thành công!");
                callback(data);
              } else showNotification("error", "Lỗi khi đặt thời hạn: " + data.message);
            })
            .catch(err => showNotification("error", "Lỗi kết nối: " + err));
        },
        exportStudents: function() {
          fetch('/api/export_students_excel')
            .then(response => response.blob())
            .then(blob => {
              const url = window.URL.createObjectURL(blob);
              // Tên file được đặt theo định dạng ngày-tháng-năm
              const filename = new Date().toLocaleDateString("vi-VN").replace(/\//g, "-") + ".xlsx";
              const a = document.createElement('a');
              a.href = url;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              a.remove();
            })
            .catch(err => showNotification("error", "Lỗi khi xuất danh sách: " + err));
        },
        addUser: function(username, password, role, callback) {
          fetch('/api/add_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, role })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification("success", "Thêm người dùng thành công!");
                callback();
              } else showNotification("error", "Lỗi khi thêm tài khoản: " + data.message);
            })
            .catch(err => showNotification("error", "Lỗi kết nối: " + err));
        },
        editUser: function(userId, username, password, role, callback) {
          fetch('/api/edit_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: userId, username, password, role })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification("success", "Chỉnh sửa người dùng thành công!");
                callback();
              } else showNotification("error", "Lỗi khi chỉnh sửa tài khoản: " + data.message);
            })
            .catch(err => showNotification("error", "Lỗi kết nối: " + err));
        },
        deleteUser: function(userId, callback) {
          fetch('/api/delete_user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: userId })
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                showNotification("success", "Xoá người dùng thành công!");
                callback();
              } else showNotification("error", "Lỗi khi xoá tài khoản: " + data.message);
            })
            .catch(err => showNotification("error", "Lỗi kết nối: " + err));
        },
        fetchUsers: function(callback) {
          fetch('/api/users')
            .then(response => response.json())
            .then(data => {
              if (data.success) callback(data.users);
              else showNotification("error", "Lỗi khi lấy danh sách người dùng: " + data.message);
            })
            .catch(err => showNotification("error", "Lỗi kết nối: " + err));
        }
      };

      // Gán sự kiện cho nút Xuất danh sách
      document.getElementById("export-students").addEventListener("click", () => {
        PanelFunctions.exportStudents();
      });

      // Xử lý các sự kiện cho popup và thao tác với học sinh
      const folderInput = document.getElementById("batch-folder-input");
      document.getElementById("batch-add").addEventListener("click", () => {
        document.getElementById("batch-student-count").querySelector("span").textContent = "0";
        openModal("batch-add-modal");
      });
      document.getElementById("select-folder").addEventListener("click", () => {
        folderInput.click();
      });
      folderInput.addEventListener("change", (e) => {
        const files = e.target.files;
        if (files.length > 0) {
          document.getElementById("batch-student-count").querySelector("span").textContent = files.length;
        }
      });
      document.getElementById("save-batch-add").addEventListener("click", () => {
        const files = folderInput.files;
        if (files.length > 0) {
          const folderName = files[0].webkitRelativePath.split("/")[0];
          PanelFunctions.batchAddStudents(folderName, () => {
            PanelFunctions.fetchStudents(renderStudents);
            closeModal("batch-add-modal");
          });
        } else {
          alert("Vui lòng chọn thư mục.");
        }
      });
      document.getElementById("cancel-batch-add").addEventListener("click", () => closeModal("batch-add-modal"));

      // Popup Đặt Thời Hạn Điểm Danh
      document.getElementById("set-cutoff").addEventListener("click", () => {
        document.getElementById("cutoff-gmt").value = "";
        document.getElementById("cutoff-time").value = "";
        openModal("set-cutoff-modal");
      });
      document.getElementById("save-cutoff").addEventListener("click", () => {
        const gmt = document.getElementById("cutoff-gmt").value;
        const cutoff = document.getElementById("cutoff-time").value;
        if (gmt && cutoff) {
          PanelFunctions.setCutoff(gmt, cutoff, data => {
            alert("Đã cài đặt hạn chót: " + JSON.stringify(data));
            closeModal("set-cutoff-modal");
          });
        } else {
          alert("Vui lòng nhập đầy đủ thông tin.");
        }
      });
      document.getElementById("cancel-cutoff").addEventListener("click", () => closeModal("set-cutoff-modal"));

      // Popup Thêm Học Sinh
      document.getElementById("add-student").addEventListener("click", () => {
        document.getElementById("add-image").value = "";
        document.getElementById("add-HoVaTen").value = "";
        document.getElementById("add-Lop").value = "";
        document.getElementById("add-Gender").value = "";
        document.getElementById("add-NgaySinh").value = "";
        openModal("add-student-modal");
      });
      document.getElementById("add-image").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) autofillFromFilename(file.name, "add-HoVaTen", "add-Lop");
      });
      document.getElementById("save-add-student").addEventListener("click", () => {
        const fileInput = document.getElementById("add-image");
        const imagePath = fileInput.files[0] ? fileInput.files[0].name : "";
        const HoVaTen = document.getElementById("add-HoVaTen").value;
        const Lop = document.getElementById("add-Lop").value;
        const Gender = document.getElementById("add-Gender").value;
        const NgaySinh = document.getElementById("add-NgaySinh").value;
        const UID = Date.now().toString() + Math.floor(Math.random() * 900 + 100).toString();
        if (imagePath && HoVaTen && Lop && Gender && NgaySinh) {
          PanelFunctions.addStudent({ UID, HoVaTen, NgaySinh, Lop, Gender, ImagePath: imagePath }, () => {
            PanelFunctions.fetchStudents(renderStudents);
            closeModal("add-student-modal");
          });
        } else {
          alert("Vui lòng nhập đầy đủ thông tin.");
        }
      });
      document.getElementById("cancel-add-student").addEventListener("click", () => closeModal("add-student-modal"));

      // Popup Chỉnh Sửa Học Sinh
      document.getElementById("edit-student").addEventListener("click", () => {
        if (!selectedStudent) {
          alert("Vui lòng chọn học sinh cần chỉnh sửa.");
          return;
        }
        document.getElementById("edit-HoVaTen").value = selectedStudent.HoVaTen;
        document.getElementById("edit-Lop").value = selectedStudent.Lop;
        document.getElementById("edit-Gender").value = selectedStudent.Gender;
        document.getElementById("edit-NgaySinh").value = selectedStudent.NgaySinh;
        document.getElementById("edit-ImagePath").value = selectedStudent.ImagePath;
        document.getElementById("edit-image").value = "";
        openModal("edit-student-modal");
      });
      document.getElementById("edit-image").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) autofillFromFilename(file.name, "edit-HoVaTen", "edit-Lop");
      });
      document.getElementById("save-edit-student").addEventListener("click", () => {
        if (!selectedStudent) return;
        const fileInput = document.getElementById("edit-image");
        const imagePath = fileInput.files[0] ? fileInput.files[0].name : document.getElementById("edit-ImagePath").value;
        const HoVaTen = document.getElementById("edit-HoVaTen").value;
        const Lop = document.getElementById("edit-Lop").value;
        const Gender = document.getElementById("edit-Gender").value;
        const NgaySinh = document.getElementById("edit-NgaySinh").value;
        if (imagePath && HoVaTen && Lop && Gender && NgaySinh) {
          PanelFunctions.editStudent(selectedStudent.id, { HoVaTen, Lop, Gender, NgaySinh, ImagePath: imagePath }, () => {
            PanelFunctions.fetchStudents(renderStudents);
            closeModal("edit-student-modal");
          });
        } else {
          alert("Vui lòng nhập đầy đủ thông tin.");
        }
      });
      document.getElementById("cancel-edit-student").addEventListener("click", () => closeModal("edit-student-modal"));

      // Xoá Học Sinh (sử dụng UID)
      document.getElementById("delete-student").addEventListener("click", () => {
        if (!selectedStudent) {
          alert("Vui lòng chọn học sinh cần xoá.");
          return;
        }
        if (confirm("Bạn có chắc muốn xoá học sinh có UID " + selectedStudent.UID + "?")) {
          PanelFunctions.deleteStudent(selectedStudent.UID, () => {
            PanelFunctions.fetchStudents(renderStudents);
          });
        }
      });

      // Người dùng
      function fetchUsers() {
        PanelFunctions.fetchUsers(renderUsers);
      }
      fetchUsers();

      // Popup Thêm Người Dùng
      document.getElementById("add-user-btn").addEventListener("click", () => {
        document.getElementById("add-username").value = "";
        document.getElementById("add-password").value = "";
        document.getElementById("add-role").value = "user";
        openModal("add-user-modal");
      });
      document.getElementById("save-add-user").addEventListener("click", () => {
        const username = document.getElementById("add-username").value;
        const password = document.getElementById("add-password").value;
        const role = document.getElementById("add-role").value;
        if (username && password && role) {
          PanelFunctions.addUser(username, password, role, () => {
            fetchUsers();
            closeModal("add-user-modal");
          });
        } else {
          alert("Vui lòng nhập đầy đủ thông tin.");
        }
      });
      document.getElementById("cancel-add-user").addEventListener("click", () => closeModal("add-user-modal"));

      // Popup Chỉnh Sửa Người Dùng
      document.getElementById("edit-user-btn").addEventListener("click", () => {
        if (!selectedUser) {
          alert("Vui lòng chọn người dùng cần chỉnh sửa.");
          return;
        }
        document.getElementById("edit-username").value = selectedUser.username;
        document.getElementById("edit-password").value = ""; // Để trống nếu không đổi mật khẩu
        document.getElementById("edit-role").value = selectedUser.role;
        openModal("edit-user-modal");
      });
      document.getElementById("save-edit-user").addEventListener("click", () => {
        if (!selectedUser) return;
        const username = document.getElementById("edit-username").value;
        const password = document.getElementById("edit-password").value;
        const role = document.getElementById("edit-role").value;
        if (username && password && role) {
          PanelFunctions.editUser(selectedUser.id, username, password, role, () => {
            fetchUsers();
            closeModal("edit-user-modal");
          });
        } else {
          alert("Vui lòng nhập đầy đủ thông tin.");
        }
      });
      document.getElementById("cancel-edit-user").addEventListener("click", () => closeModal("edit-user-modal"));

      // Popup Xoá Người Dùng
      document.getElementById("delete-user-btn").addEventListener("click", () => {
        if (!selectedUser) {
          alert("Vui lòng chọn người dùng cần xoá.");
          return;
        }
        document.getElementById("delete-username-display").textContent = selectedUser.username;
        openModal("delete-user-modal");
      });
      document.getElementById("confirm-delete-user").addEventListener("click", () => {
        if (!selectedUser) return;
        PanelFunctions.deleteUser(selectedUser.id, () => {
          fetchUsers();
          closeModal("delete-user-modal");
        });
      });
      document.getElementById("cancel-delete-user").addEventListener("click", () => closeModal("delete-user-modal"));

      // Đăng xuất & Thoát
      document.getElementById("logout").addEventListener("click", () => window.location.href = "/");
      document.getElementById("quit").addEventListener("click", () => { if (confirm("Bạn có chắc muốn thoát?")) window.close(); });

      // Load danh sách học sinh ban đầu
      PanelFunctions.fetchStudents(renderStudents);
    });
  </script>
</body>
</html>
